<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=yes">
<title>Mobile Mindâ€‘Map</title>

<script src="https://unpkg.com/cytoscape@3/dist/cytoscape.min.js"></script>
<script src="https://unpkg.com/webcola@3.4.0/WebCola/cola.min.js"></script>
<script src="https://unpkg.com/cytoscape-cola@2/cytoscape-cola.js"></script>

<style>
:root{
  --bg:#0d1117;  --panel:#161b22;  --border:#30363d;  --txt:#e6edf3;
  --node:#475569; --node-h:#64748b;
  --root:#3b82f6; --root-outline:#facc15;
  --edge:#cbd5e1; --edge-bg:#0f172a;
  --btn:#238636;  --btn-h:#2ea043; --btn-d:#3d434a;
}
*{box-sizing:border-box;margin:0}
html,body{height:100%;display:flex;flex-direction:column;font-family:system-ui,sans-serif;background:var(--bg);color:var(--txt)}
#controls{padding:8px;background:var(--panel);border-bottom:1px solid var(--border);display:flex;flex-direction:column;gap:6px}
details{margin-top:6px}summary{cursor:pointer;font-weight:600}
#jsonBox textarea{width:100%;height:150px;font-family:monospace;background:#0f172a;color:#c9d1d9;border:1px solid var(--border);border-radius:6px}
code#promptPreview{white-space:pre-wrap;word-break:break-word;display:block}
.btn{padding:6px 14px;border:0;border-radius:6px;font-weight:600;cursor:pointer}
.btn.main{background:var(--btn);color:#fff}.btn.main:hover{background:var(--btn-h)}
.btn.aux{background:var(--node-h);color:#111;padding:6px 10px}
.btn.aux.active{background:var(--btn);color:#fff}
.btn.aux:disabled{background:var(--btn-d);color:#666;cursor:not-allowed}
#actionRow{display:flex;gap:6px;align-items:center;flex-wrap:wrap}
#cy{flex:1;touch-action:none}

/* ---------- node context menu ---------- */
#nodeMenu{
  position:absolute;display:none;max-width:calc(100vw - 20px);
  background:var(--panel);border:none;border-radius:8px;
  padding:8px;box-shadow:0 4px 10px rgba(0,0,0,.45);z-index:1000}
#nodeMenu.dragging{opacity:.85;transition:none}
#nodeMenu button{
  display:block;width:auto;margin:3px 0;padding:6px 14px;font-size:13px;
  background:var(--node);color:#fff;border:0;border-radius:4px;white-space:nowrap}
#nodeMenu button:hover{background:var(--node-h)}
.selected{border:2px solid #f9a825 !important}

/* prompt builder row oneâ€‘line */
.promptRow{display:flex;align-items:center;gap:6px;flex-wrap:nowrap}
.promptRow input{flex:1 1 auto;min-width:0}

/* overlay */
#overlay{position:fixed;inset:0;background:#000a;backdrop-filter:blur(2px);display:flex;
         align-items:center;justify-content:center;z-index:2000}
#overlayInner{width:90%;max-width:600px;background:var(--panel);border:1px solid var(--border);
              border-radius:8px;padding:12px;display:flex;flex-direction:column;gap:8px}
#overlayInner textarea{flex:1;min-height:200px;background:#0f172a;color:#c9d1d9;border:1px solid var(--border);
                       border-radius:6px;font-family:monospace}
#overlayInner div{display:flex;gap:8px;justify-content:flex-end}

/* donate */
#donate{padding:10px;background:var(--panel);border-top:1px solid var(--border);cursor:pointer;font-size:13px}
#donate.hide{opacity:0;height:0;padding:0;border:none;overflow:hidden;transition:.25s}
#donate b{color:#c9d1d9}#donate a{color:#58a6ff;text-decoration:none}
</style>
</head>
<body>
<div id="controls">
  <details id="builder">
    <summary>Prompt builder (click to open)</summary>
    <p>Enter a topic or link â†’ <b>Copy Prompt</b> â†’ paste into ChatGPT.</p>

    <div class="promptRow">
      <input id="topicInput" placeholder="Topic or https://â€¦" style="padding:6px;border-radius:6px;border:1px solid var(--border);background:#0f172a;color:#c9d1d9">
      <button id="copyPromptBtn"  class="btn main">Copy Prompt</button>
      <button id="pastePromptBtn" class="btn aux" title="Paste from clipboard">ðŸ“‹</button>
    </div>

    <p style="margin:6px 0 2px">Preview:</p><code id="promptPreview"></code>
  </details>

  <details id="jsonBox" open>
    <summary>JSON (click to show / hide)</summary>
    <textarea id="jsonInput" placeholder="Paste ChatGPTâ€™s JSON here, then hit Render Map"></textarea>
  </details>

  <div id="actionRow">
    <button id="renderBtn" class="btn main" style="flex:1">RenderÂ Map</button>
    <button id="pasteBtn"  class="btn aux" title="Paste JSON to overwrite">ðŸ“‹</button>
    <button id="copyJsonBtn" class="btn aux" title="Copy JSON to clipboard">ðŸ“„</button>
    <button id="multiBtn"   class="btn aux" title="Toggle multiâ€‘select">â‡³</button>
    <button id="undoBtn"   class="btn aux" title="Undo" disabled>âŸ²</button>
    <button id="redoBtn"   class="btn aux" title="Redo" disabled>âŸ³</button>
  </div>
</div>

<div id="cy"></div>

<!-- node context menu -->
<div id="nodeMenu">
  <button id="copyTextBtn">Copy text</button>
  <button id="nodeCopy">Copy Prompt for selected</button>
  <button id="nodeDelete">Delete node & subtree</button>
  <button id="childDelete">Delete ONLY children</button>
</div>

<!-- largeâ€‘text paste overlay -->
<div id="overlay" style="display:none">
  <div id="overlayInner">
    <textarea placeholder="Paste JSON here"></textarea>
    <div><button id="ovCancel" class="btn aux">Cancel</button><button id="ovOk" class="btn main">OK</button></div>
  </div>
</div>

<section id="donate" title="Tap to hide">
  <h3 style="margin:0 0 4px;font-size:14px">Support citizenâ€‘science projects <span style="font-size:11px;opacity:.6">(tap to hide)</span></h3>
  <p><b>Gridcoin</b>Â â€” rewards BOINC distributedâ€‘computing research.<br>Address: <code>SG5RCw9cf2RhbopCuXLzYYpXciARaZNCF8</code></p>
  <p><b>Curecoin</b>Â â€” rewards Folding@home proteinâ€‘folding research.<br>Address: <code>BRaK31UtcWKM6wqbFFU8bXDSc1b8NkvP7h</code></p>
  <p>Feedback â†’ <a href="mailto:Foxes.owo@gmaill.com">Foxes.owo@gmaill.com</a></p>
</section>

<script>
/* ---------- helpers ---------- */
const MAXLEN=50, WRAP=12, ZWSP="\u200B";
const wrap=t=>{const s=t.length>MAXLEN?t.slice(0,47)+"â€¦":t;
  return s.includes(" ")||s.length<=WRAP?s:s.replace(new RegExp(`(.{${WRAP}})`,"g"),`$1${ZWSP}`);};
const sanitize=t=>{let s=t.trim().replace(/^```[^\n]*\n?|```$/g,"");
  const m=s.match(/({[\s\S]*})/m); s=m?m[1]:"";
  return s.replace(/\\(?!["\/bfnrtu])/g,"").replace(/\\(?=[\[\]{}])/g,"");};
const parseJSON=t=>{try{return JSON.parse(t);}catch{return null;}};

/* ---------- prompt builder (unchanged) ---------- */
const topicInput=document.getElementById("topicInput"),
      promptPreview=document.getElementById("promptPreview"),
      copyPromptBtn=document.getElementById("copyPromptBtn"),
      pastePromptBtn=document.getElementById("pastePromptBtn");
const isURL=s=>/^https?:\/\//i.test(s.trim());
function makePrompt(t){
  if(isURL(t)){return `Analyse the page ${t} and output ONLY raw JSON.\n\nâ€¢ Add "link":"${t}" at top level (do NOT add it as a node).\nâ€¢ IDs must start with "n0" for the root, followed by n1, n2 â€¦ consecutively.\n\nSchema:\n{\n "link":"${t}",\n "root":"n0",\n "nodes":[{ "id":"n0","text":"<root label>","parent":"" }],\n "edges":[{ "source":"...","target":"...","label":"...","direction":"out" }]\n}\n\nReturn ONLY the JSON object (no Markdown, no code fences).`; }
  return `Create a mindâ€‘map for "${t}" and output ONLY raw JSON.\n\nâ€¢ IDs must start with "n0" for the root, followed by n1, n2 â€¦ consecutively.\n\nSchema:\n{\n "root":"n0",\n "nodes":[{ "id":"n0","text":"<root label>","parent":"" }],\n "edges":[{ "source":"...","target":"...","label":"...","direction":"out" }]\n}\n\nReturn ONLY the JSON object (no Markdown, no code fences).`; }
topicInput.oninput=()=>promptPreview.textContent=makePrompt(topicInput.value.trim()||"<topic>");
promptPreview.textContent=makePrompt("<topic>");
copyPromptBtn.onclick=()=>{const t=topicInput.value.trim();if(!t){alert("Enter topic / URL");return;}
  navigator.clipboard.writeText(makePrompt(t));document.getElementById("builder").open=false;};
pastePromptBtn.onclick=async()=>{
  if(navigator.clipboard?.readText){
    try{topicInput.value=(await navigator.clipboard.readText()).trim();topicInput.oninput();return;}catch{}
  }
  const v=prompt("Paste topic / URL");if(v!==null){topicInput.value=v.trim();topicInput.oninput();}
};

/* ---------- history ---------- */
let dataObj={},hist=[],idx=-1;
const undoBtn=document.getElementById("undoBtn"),redoBtn=document.getElementById("redoBtn");
function updateUR(){undoBtn.disabled=idx<=0;redoBtn.disabled=idx>=hist.length-1;}
function pushHist(t){hist.splice(idx+1);hist.push(t);idx=hist.length-1;updateUR();}

/* ---------- JSON clipboard ---------- */
const jsonInput=document.getElementById("jsonInput");
document.getElementById("copyJsonBtn").onclick=()=>navigator.clipboard.writeText(jsonInput.value||"");
const overlay=document.getElementById("overlay");
document.getElementById("pasteBtn").onclick=async()=>{
  if(navigator.clipboard?.readText){
    try{jsonInput.value=sanitize(await navigator.clipboard.readText());return;}catch{}
  }
  overlay.style.display="flex";
};
document.getElementById("ovCancel").onclick=()=>overlay.style.display="none";
document.getElementById("ovOk").onclick=()=>{jsonInput.value=sanitize(overlay.querySelector("textarea").value);overlay.style.display="none";};

/* ---------- Cytoscape initialisation ---------- */
let cy,layout; cytoscape.use(cytoscapeCola);
function initCy(){
  if(cy)return;
  cy=cytoscape({container:document.getElementById("cy"),wheelSensitivity:.25,
    style:[
      {selector:"node",style:{label:"data(label)","text-wrap":"wrap","text-max-width":"240px","text-valign":"center","text-halign":"center",
        "background-color":"var(--node)","shape":"round-rectangle","padding":"6px",width:"label",height:"label","font-size":"13px",
        color:"#fff","text-outline-color":"#000","text-outline-width":1}},
      {selector:"node.root",style:{"background-color":"var(--root)","border-width":4,"border-color":"var(--root-outline)",
        "text-outline-color":"#000","text-outline-width":3,"font-size":"15px","font-weight":"700"}},
      {selector:"node.selected",style:{'border-color':'#f9a825','border-width':2}},
      {selector:"node:hover",style:{"background-color":"var(--node-h)"}},
      {selector:"edge",style:{width:2,"line-color":"var(--edge)","target-arrow-color":"var(--edge)","target-arrow-shape":"triangle",
        "curve-style":"bezier",label:"data(label)","font-size":"11px",color:"#e6edf3","text-rotation":"autorotate",
        "text-background-opacity":.9,"text-background-color":"var(--edge-bg)","text-background-padding":"2px"}},
      {selector:'edge[label=""]',style:{label:'','text-background-opacity':0}}
    ]});
  cy.on("tap",e=>{if(e.target===cy)clearSelection();});
  cy.on("tap","node",tapNode);
}
function physics(){layout?.stop();layout=cy.layout({name:"cola",infinite:true,animate:true,refresh:1,nodeSpacing:25,edgeLength:200,padding:40,fit:false});layout.run();}

/* ---------- selection & menu ---------- */
const sel=new Set(); let multi=false;
const multiBtn=document.getElementById("multiBtn");
multiBtn.onclick=()=>{multi=!multi;multiBtn.classList.toggle("active",multi);if(!multi)clearSelection();};

function clearSelection(){sel.forEach(id=>cy.getElementById(id).removeClass("selected"));sel.clear();nodeMenu.style.display="none";}
function selectionNames(){return [...sel].map(id=>cy.getElementById(id).data("full")).join(", ");}

const nodeMenu=document.getElementById("nodeMenu"),
      copyTextBtn=document.getElementById("copyTextBtn"),
      nodeCopyBtn=document.getElementById("nodeCopy"),
      delBtn=document.getElementById("nodeDelete"),
      childBtn=document.getElementById("childDelete");

function clamp(x,y){
  const mw=nodeMenu.offsetWidth,mh=nodeMenu.offsetHeight;
  if(x+mw>innerWidth-10)x=innerWidth-mw-10;if(x<10)x=10;
  if(y+mh>innerHeight-10)y=innerHeight-mh-10;if(y<10)y=10;
  return [x,y];
}
function openMenu(pos){
  copyTextBtn.textContent=sel.size>1?"Copy texts":"Copy text";
  nodeCopyBtn.textContent=sel.size>1?"Copy Prompt for selected":"Copy Prompt for this node";
  copyTextBtn.dataset.names=nodeCopyBtn.dataset.names=selectionNames();
  const rootSel=[...sel].includes("n0");
  delBtn.textContent=rootSel&&sel.size===1?"Delete entire graph":"Delete node & subtree";

  nodeMenu.style.display="block";
  let [x,y]=clamp(pos.x+20+cy.container().getBoundingClientRect().left,
                  pos.y+20+cy.container().getBoundingClientRect().top);
  nodeMenu.style.left=x+"px";nodeMenu.style.top=y+"px";
}

function tapNode(e){
  const node=e.target,id=node.id();
  if(!multi){clearSelection();sel.add(id);node.addClass("selected");}
  else{
    if(sel.has(id)){sel.delete(id);node.removeClass("selected");}
    else{sel.add(id);node.addClass("selected");}
  }
  sel.size?openMenu(e.renderedPosition):nodeMenu.style.display="none";
}

/* drag menu ------------------------------------------------------------ */
let dragOff=null;
function dragStart(ev){
  // start only if background pressed (not button)
  if(ev.target.tagName==='BUTTON')return;
  const pt=ev.touches?ev.touches[0]:ev;
  dragOff={x:pt.clientX-parseFloat(nodeMenu.style.left),y:pt.clientY-parseFloat(nodeMenu.style.top)};
  nodeMenu.classList.add("dragging");
  document.addEventListener(ev.touches?"touchmove":"mousemove",dragMove,{passive:false});
  document.addEventListener(ev.touches?"touchend":"mouseup",dragEnd,{once:true});
}
function dragMove(ev){
  ev.preventDefault();
  if(!dragOff)return;
  const pt=ev.touches?ev.touches[0]:ev;
  let [x,y]=clamp(pt.clientX-dragOff.x,pt.clientY-dragOff.y);
  nodeMenu.style.left=x+"px";nodeMenu.style.top=y+"px";
}
function dragEnd(){
  dragOff=null;nodeMenu.classList.remove("dragging");
  document.removeEventListener("mousemove",dragMove);
  document.removeEventListener("touchmove",dragMove);
}
nodeMenu.addEventListener("mousedown",dragStart);
nodeMenu.addEventListener("touchstart",dragStart,{passive:false});

/* ---------- menu actions ---------- */
copyTextBtn.onclick=()=>{navigator.clipboard.writeText(copyTextBtn.dataset.names||"");nodeMenu.style.display="none";};
nodeCopyBtn.onclick=()=>{
  const names=nodeCopyBtn.dataset.names||"";if(!names)return;
  const link=dataObj.link?`"link":"${dataObj.link}",\n`:"";
  const p=`Extend and refactor node "${names}"

Keep "link" key if present, and IDs MUST remain n0 (root), n1, n2 â€¦

Schema:
{
 ${link}"root":"n0",
 "nodes":[{ "id":"n0","text":"<root label>","parent":"" }, â€¦ ],
 "edges":[{ "source":"...","target":"...","label":"...","direction":"out" }]
}

Return ONLY the JSON object.

Current JSON:
${jsonInput.value}`;
  navigator.clipboard.writeText(p);nodeMenu.style.display="none";
};

/* deletion helpers */
function subtree(id,incRoot){
  const set=new Set(incRoot?[id]:[]),q=[id];
  while(q.length){
    const cur=q.pop();
    dataObj.edges.forEach(e=>{if(e.source===cur&&!set.has(e.target)){set.add(e.target);q.push(e.target);} });
    dataObj.nodes.forEach(n=>{if(n.parent===cur&&!set.has(n.id)){set.add(n.id);q.push(n.id);} });
  }return set;}
function remove(set){dataObj.nodes=dataObj.nodes.filter(n=>!set.has(n.id));
  dataObj.edges=dataObj.edges.filter(e=>!set.has(e.source)&&!set.has(e.target));}
delBtn.onclick=()=>{
  if(!sel.size)return;
  if(sel.has("n0")&&sel.size===1){
    if(!confirm("Delete entire graph?"))return;
    dataObj={};jsonInput.value="";cy.elements().remove();pushHist("");clearSelection();return;
  }
  const doomed=new Set();sel.forEach(id=>subtree(id,true).forEach(x=>doomed.add(x)));
  remove(doomed);jsonInput.value=JSON.stringify(dataObj,null,2);clearSelection();render(true,false);
};
childBtn.onclick=()=>{
  if(!sel.size)return;
  const doomed=new Set();sel.forEach(id=>subtree(id,false).forEach(x=>doomed.add(x)));
  remove(doomed);jsonInput.value=JSON.stringify(dataObj,null,2);clearSelection();render(true,false);
};

/* ---------- render ---------- */
function buildEls(){const a=[],dup=new Set(dataObj.edges?.map(e=>e.source+"â†’"+e.target)||[]);
  (dataObj.nodes||[]).forEach(n=>{a.push({data:{id:n.id,label:wrap(n.text),full:n.text},classes:n.id==="n0"?"root":""});
    if(n.parent&&!dup.has(n.parent+"â†’"+n.id))a.push({data:{source:n.parent,target:n.id,label:"parent"}});});
  (dataObj.edges||[]).forEach(e=>a.push({data:{source:e.source,target:e.target,label:e.label||"rel"}}));return a;}
function render(store=true){
  const txt=sanitize(jsonInput.value);if(!txt){cy&&cy.elements().remove();dataObj={};updateUR();return;}
  const obj=parseJSON(txt);if(!obj){alert("Invalid JSON");return;}
  dataObj=obj;dataObj.root="n0";
  initCy();cy.elements().remove();cy.add(buildEls());physics();clearSelection();
  if(store)pushHist(JSON.stringify(dataObj,null,2));else updateUR();
}
document.getElementById("renderBtn").onclick=()=>render(true);

/* history buttons */
undoBtn.onclick=()=>{if(idx>0){idx--;jsonInput.value=hist[idx];render(false);}};
redoBtn.onclick=()=>{if(idx<hist.length-1){idx++;jsonInput.value=hist[idx];render(false);}};
addEventListener("keydown",e=>{
  if(e.ctrlKey&&!e.shiftKey&&e.key==="z"){e.preventDefault();undoBtn.onclick();}
  if(e.ctrlKey&&(e.key==="y"||e.key==="Z"&&e.shiftKey)){e.preventDefault();redoBtn.onclick();}
});

/* donation banner */
document.getElementById("donate").onclick=e=>e.currentTarget.classList.add("hide");
</script>
</body>
</html>

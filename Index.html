<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=yes">
<title>Mobile Mindâ€‘Map</title>

<script src="https://unpkg.com/cytoscape@3/dist/cytoscape.min.js"></script>
<script src="https://unpkg.com/webcola@3.4.0/WebCola/cola.min.js"></script>
<script src="https://unpkg.com/cytoscape-cola@2/cytoscape-cola.js"></script>

<style>
:root{
  --bg:#0d1117;  --panel:#161b22;  --border:#30363d;  --txt:#e6edf3;
  --node:#475569; --node-h:#64748b;
  --root:#3b82f6; --root-outline:#facc15;
  --edge:#cbd5e1; --edge-bg:#0f172a;
  --btn:#238636;  --btn-h:#2ea043; --btn-d:#3d434a;
}
*{box-sizing:border-box;margin:0}
html,body{height:100%;display:flex;flex-direction:column;font-family:system-ui,sans-serif;background:var(--bg);color:var(--txt)}
#controls{padding:8px;background:var(--panel);border-bottom:1px solid var(--border);display:flex;flex-direction:column;gap:6px}
details{margin-top:6px}summary{cursor:pointer;font-weight:600}
#jsonBox textarea{width:100%;height:150px;font-family:monospace;background:#0f172a;color:#c9d1d9;border:1px solid var(--border);border-radius:6px}
.btn{padding:6px 14px;border:0;border-radius:6px;font-weight:600;cursor:pointer}
.btn.main{background:var(--btn);color:#fff}.btn.main:hover{background:var(--btn-h)}
.btn.aux{background:var(--node-h);color:#111;padding:6px 10px}
.btn.aux:disabled{background:var(--btn-d);color:#666;cursor:not-allowed}
#actionRow{display:flex;gap:6px;align-items:center;flex-wrap:wrap}
#cy{flex:1;touch-action:none}
#nodeMenu{position:absolute;background:var(--panel);border:1px solid var(--border);border-radius:6px;padding:6px;box-shadow:0 4px 10px rgba(0,0,0,.4);display:none;z-index:1000}
#nodeMenu button{margin:4px 0;width:190px;font-size:13px;padding:4px 10px}
#donate{padding:10px;background:var(--panel);border-top:1px solid var(--border);cursor:pointer;font-size:13px}
#donate.hide{opacity:0;height:0;padding:0;border:none;overflow:hidden;transition:.25s}
#donate b{color:#c9d1d9}#donate a{color:#58a6ff;text-decoration:none}
</style>
</head>
<body>
<div id="controls">
  <!-- Prompt builder (collapsed by default) -->
  <details id="builder">
    <summary>Prompt builder (click to open)</summary>
    <p>Enter a topic or link â†’ <b>Copy Prompt</b> â†’ paste into ChatGPT.<br>ChatGPT must return valid JSON you can paste below.</p>
    <input id="topicInput" placeholder="Topic or https://â€¦" style="width:60%;padding:6px;border-radius:6px;border:1px solid var(--border);background:#0f172a;color:#c9d1d9">
    <button id="copyPromptBtn" class="btn main">Copy Prompt</button>
    <p style="margin:6px 0 2px">Preview:</p><code id="promptPreview"></code>
  </details>

  <!-- JSON area -->
  <details id="jsonBox" open>
    <summary>JSON (click to show / hide)</summary>
    <textarea id="jsonInput" placeholder="Paste ChatGPTâ€™s JSON here, then hit Render Map"></textarea>
  </details>

  <div id="actionRow">
    <button id="renderBtn" class="btn main" style="flex:1">RenderÂ Map</button>
    <button id="pasteBtn"  class="btn aux" title="Paste JSON to overwrite">ðŸ“‹</button>
    <button id="undoBtn"   class="btn aux" title="Undo" disabled>âŸ²</button>
    <button id="redoBtn"   class="btn aux" title="Redo" disabled>âŸ³</button>
  </div>
</div>

<div id="cy"></div>

<!-- floating node menu -->
<div id="nodeMenu">
  <button id="nodeCopy">Copy Prompt for this node</button>
  <button id="nodeDelete">Delete node & subtree</button>
  <button id="childDelete">Delete ONLY children</button>
</div>

<!-- donation -->
<section id="donate" title="Tap to hide"><h3 style="margin:0 0 4px;font-size:14px">
  Support citizenâ€‘science projects <span style="font-size:11px;opacity:.6">(tap to hide)</span></h3>
  <p><b>Gridcoin</b>Â â€” rewards BOINC distributedâ€‘computing research.<br>Address: <code>SG5RCw9cf2RhbopCuXLzYYpXciARaZNCF8</code></p>
  <p><b>Curecoin</b>Â â€” rewards Folding@home proteinâ€‘folding research.<br>Address: <code>BRaK31UtcWKM6wqbFFU8bXDSc1b8NkvP7h</code></p>
  <p>Suggestionsâ€¯/â€¯feedback â†’ <a href="mailto:Foxes.owo@gmaill.com">Foxes.owo@gmaill.com</a></p>
</section>

<script>
/* ---------- helpers (UPDATED sanitizer) ---------- */
const ZWSP="\u200B",WRAP=12;
const wrap=s=>s.includes(' ')||s.length<=WRAP?s:s.replace(new RegExp(`(.{${WRAP}})`,'g'),`$1${ZWSP}`);
function clean(t){
  return t.trim()
    .replace(/^```[^\n]*\n?|```$/g,'')            // strip fences
    .replace(/\\(?!["\/bfnrtu])/g,'')             // strip extraneous backslashes
    .replace(/\\(?=[\[\]{}])/g,'');               // strip \ before braces / brackets
}
const parseJSON=t=>{try{return JSON.parse(t);}catch{return null;}};

/* ---------- prompt builder (unchanged text) ---------- */
const topicInput=document.getElementById('topicInput'),promptPreview=document.getElementById('promptPreview'),
      copyPromptBtn=document.getElementById('copyPromptBtn'),builderDetails=document.getElementById('builder');
const isURL=s=>/^https?:\/\//i.test(s.trim());
const mkPrompt=t=>{
  const pre=isURL(t)?`Analyse ${t} and output ONLY raw JSON.`:`Create a mindâ€‘map for "${t}" and output ONLY raw JSON.`;
  return `${pre}

â€¢ IDs must start with "n0" for the root, followed by n1, n2 â€¦ consecutively.

Schema:
{
 "root":"n0",
 "nodes":[{ "id":"n0","text":"<root label>","parent":"" }, â€¦ ],
 "edges":[{ "source":"...","target":"...","label":"...","direction":"out" }]
}

Return ONLY the JSON object (no Markdown / fences).`;
};
topicInput.oninput=()=>promptPreview.textContent=mkPrompt(topicInput.value.trim()||'<topic>');
promptPreview.textContent=mkPrompt('<topic>');
copyPromptBtn.onclick=()=>{
  const t=topicInput.value.trim();if(!t){alert('Enter topic or URL');return;}
  navigator.clipboard.writeText(mkPrompt(t));
  builderDetails.removeAttribute('open');
};

/* ---------- global data & history ---------- */
let dataObj={},hist=[],idx=-1;
function pushHist(txt){hist.splice(idx+1);hist.push(txt);idx=hist.length-1;updateUR();}
function updateUR(){undoBtn.disabled=idx<=0;redoBtn.disabled=idx>=hist.length-1;}

/* ---------- DOM refs ---------- */
const jsonInput=document.getElementById('jsonInput'),renderBtn=document.getElementById('renderBtn'),
      pasteBtn=document.getElementById('pasteBtn'),undoBtn=document.getElementById('undoBtn'),redoBtn=document.getElementById('redoBtn');
pasteBtn.onclick=()=>{const r=prompt('Paste JSON / ChatGPT output');if(r)jsonInput.value=clean(r);};

/* ---------- cytoscape ---------- */
let cy; cytoscape.use(cytoscapeCola);
function ensureCy(){
  if(cy)return;
  cy=cytoscape({container:document.getElementById('cy'),wheelSensitivity:.25,
    style:[
      {selector:'node',style:{label:'data(label)','text-wrap':'wrap','text-max-width':'240px',
        'text-valign':'center','text-halign':'center','background-color':'var(--node)',
        'shape':'round-rectangle','padding':'6px',width:'label',height:'label','font-size':'13px',
        color:'#fff','text-outline-color':'#000','text-outline-width':1}},
      {selector:'node:hover',style:{'background-color':'var(--node-h)'}},
      {selector:'node.root',style:{'background-color':'var(--root)','border-width':4,'border-color':'var(--root-outline)',
        'text-outline-color':'#000','text-outline-width':3,'font-size':'15px','font-weight':'700'}},
      {selector:'edge',style:{width:2,'line-color':'var(--edge)','target-arrow-color':'var(--edge)',
        'target-arrow-shape':'triangle','curve-style':'bezier',label:'data(label)','font-size':'11px',color:'#e6edf3',
        'text-rotation':'autorotate','text-margin-y':'-10px','text-background-opacity':.9,
        'text-background-color':'var(--edge-bg)','text-background-padding':'2px'}},
      {selector:'edge[label=""]',style:{label:'','text-background-opacity':0}}
    ]});
  cy.on('tap',e=>{if(e.target===cy)nodeMenu.style.display='none'});
  cy.on('tap','node',e=>openMenu(e.target,e.renderedPosition));
}
function lay(){cy.layout({name:'cola',animate:true,fit:false,padding:40,nodeSpacing:25,edgeLength:200}).run();}

/* ---------- fix root id ---------- */
function fixRoot(){if(dataObj.root!=="n0"){dataObj.root="n0";}}

/* ---------- elements ---------- */
const els=()=>{const arr=[],dup=new Set(dataObj.edges?.map(e=>e.source+'â†’'+e.target)||[]);
  (dataObj.nodes||[]).forEach(n=>{arr.push({data:{id:n.id,label:wrap(n.text)},classes:n.id==="n0"?'root':''});
    if(n.parent&&!dup.has(n.parent+'â†’'+n.id))arr.push({data:{source:n.parent,target:n.id,label:'parent'}});});
  (dataObj.edges||[]).forEach(e=>arr.push({data:{source:e.source,target:e.target,label:e.label||'rel'}}));return arr;};

/* ---------- node menu ---------- */
const nodeMenu=document.getElementById('nodeMenu'),delBtn=document.getElementById('nodeDelete'),childBtn=document.getElementById('childDelete');
function openMenu(node,pos){
  nodeMenu.dataset.id=node.id();const isRoot=node.id()==="n0",kids=!node.outgoers('edge').empty();
  delBtn.textContent=isRoot?'Delete entire graph':'Delete node & subtree';delBtn.style.display=kids||isRoot?'block':'none';
  childBtn.style.display=!isRoot&&kids?'block':'none';
  nodeMenu.style.display='block';nodeMenu.style.visibility='hidden';
  const r=cy.container().getBoundingClientRect(),mw=nodeMenu.offsetWidth,mh=nodeMenu.offsetHeight;
  let x=r.left+pos.x+20,y=r.top+pos.y+20;if(x+mw>innerWidth-10)x-=mw+40;if(y+mh>innerHeight-10)y-=mh+40;if(x<10)x=10;if(y<10)y=10;
  nodeMenu.style.left=x+'px';nodeMenu.style.top=y+'px';nodeMenu.style.visibility='visible';
}
/* copy prompt */
document.getElementById('nodeCopy').onclick=()=>{
  const id=nodeMenu.dataset.id,n=cy.getElementById(id);
  const p=`Extend and refactor node "${n.data('label')}" (id "${id}") and its subâ€‘graph.

IDs MUST remain n0 (root), n1, n2 â€¦ in order.

Schema (return ONLY JSON):
{
 "root":"n0",
 "nodes":[{ "id":"n0","text":"<root label>","parent":"" }, â€¦ ],
 "edges":[{ "source":"...","target":"...","label":"...","direction":"out" }]
}

Current JSON:
${jsonInput.value}`;
  navigator.clipboard.writeText(p);nodeMenu.style.display='none';
};

/* deletion helpers */
function subtree(i,inc){const s=new Set(inc?[i]:[]),q=[i];while(q.length){const id=q.pop();
  dataObj.edges.filter(e=>e.source===id).forEach(e=>{if(!s.has(e.target)){s.add(e.target);q.push(e.target);}});
  dataObj.nodes.filter(n=>n.parent===id).forEach(n=>{if(!s.has(n.id)){s.add(n.id);q.push(n.id);}});}return s;}
function remove(set){dataObj.nodes=dataObj.nodes.filter(n=>!set.has(n.id));dataObj.edges=dataObj.edges.filter(e=>!set.has(e.source)&&!set.has(e.target));
  if(set.has("n0"))dataObj.root=dataObj.nodes[0]?.id||"";}
delBtn.onclick=()=>{
  const id=nodeMenu.dataset.id,isRoot=id==="n0";if(isRoot){if(!confirm('Delete entire graph?'))return;
    dataObj={};jsonInput.value='';cy.elements().remove();pushHist('');nodeMenu.style.display='none';return;}
  remove(subtree(id,true));jsonInput.value=JSON.stringify(dataObj,null,2);nodeMenu.style.display='none';render(true,false);
};
childBtn.onclick=()=>{remove(subtree(nodeMenu.dataset.id,false));jsonInput.value=JSON.stringify(dataObj,null,2);
  nodeMenu.style.display='none';render(true,false);};

/* ---------- render ---------- */
function render(store=true){
  const txt=clean(jsonInput.value);if(!txt){cy&&cy.elements().remove();dataObj={};return;}
  const obj=parseJSON(txt);if(!obj){alert('Invalid JSON');return;}
  dataObj=obj;fixRoot();ensureCy();cy.elements().remove();cy.add(els());lay();if(store)pushHist(JSON.stringify(dataObj,null,2));
}
renderBtn.onclick=()=>render(true);

/* undo/redo */
undoBtn.onclick=()=>{if(idx>0){idx--;jsonInput.value=hist[idx];render(false);updateUR();}};
redoBtn.onclick=()=>{if(idx<hist.length-1){idx++;jsonInput.value=hist[idx];render(false);updateUR();}};
addEventListener('keydown',e=>{if(e.ctrlKey&&!e.shiftKey&&e.key==='z'){e.preventDefault();undoBtn.onclick();}
  if(e.ctrlKey&&(e.key==='y'||(e.shiftKey&&e.key==='Z'))){e.preventDefault();redoBtn.onclick();}});

/* hide banner */
document.getElementById('donate').onclick=e=>e.currentTarget.classList.add('hide');
</script>
</body>
</html>
